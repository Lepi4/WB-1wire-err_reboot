# 1-Wire watchdog с power-cycle через wb-gpio/5V_OUT

Идея: периодически проверять, что файлы датчиков 1-Wire читаются. При серии ошибок — выключить питание 1-Wire на несколько секунд и включить обратно.

## Что настроить

1. Скопировать скрипт и сделать исполняемым:

    - `/opt/w1-monitor/w1-watchdog.sh`

1. Установить systemd unit + timer:

    - `/etc/systemd/system/w1-watchdog.service`
    - `/etc/systemd/system/w1-watchdog.timer`

1. Убедиться, что команды включения/выключения питания корректны.

По умолчанию используется MQTT‑топик WB:

- OFF: `/devices/wb-gpio/controls/5V_OUT` = `0`
- ON:  `/devices/wb-gpio/controls/5V_OUT` = `1`

Если у тебя другое имя выхода — поменяй в `POWER_OFF_CMD`/`POWER_ON_CMD`.

## Параметры

В unit‑файле можно менять:

- `BUS_MASTER` — путь к шине 1‑Wire
- `SENSOR_GLOB` — маска датчиков (обычно `28-*`)
- `TEMP_FILE` — имя файла температуры (`temperature`)
- `FAIL_THRESHOLD` — сколько подряд ошибок до power‑cycle
- `POWER_CYCLE_DELAY_SEC` — пауза питания
- `STDOUT` — печатать логи в stdout (для ручного запуска)
- `LOG_TO_SYSLOG` — писать в syslog (1/0)
- `OK_LOG_INTERVAL_SEC` — как часто писать «датчики доступны» (секунды)
- `OK_LOG_EVERY_RUN` — писать «датчики доступны» на каждом запуске (1/0)

## Как работает

- Есть ли хотя бы один датчик `28-*`?
- Можно ли прочитать `temperature`?
- Если ошибки подряд больше порога — делаем power‑cycle.

## Логи

Скрипт пишет в syslog с тегом `w1-watchdog`. Чтобы логи не раздувались, при серии ошибок сообщение пишется только на первом сбое и при достижении порога. При успешной проверке пишется «датчики доступны» (по умолчанию на каждом запуске; можно отключить через `OK_LOG_EVERY_RUN=0` и оставить периодический лог по `OK_LOG_INTERVAL_SEC`). Для ручного запуска можно включить `STDOUT=1`.
